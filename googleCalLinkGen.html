<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="description" content="">
		<meta name="author" content="">
		<title>Google日曆連結產生器</title>

		<link href="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet">
		<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/css/bootstrap-datetimepicker.min.css" rel="stylesheet">
		<style>
			body{ padding:0 20px;}
			fieldset{ margin-bottom:20px; }
			legend{ font-size:16px; margin-bottom:5px;}
		</style>
	</head>
	<body>
		<div class="container">
			<div class='row'>
				<div class="col-sm-offset-1 col-sm-10">
					<h3>Google日曆連結產生器</h3>
					<div class='well well-sm'>
						<form class="form-horizontal" role="form">
							<div class="form-group">
								<label class="col-sm-2 control-label">會議名稱</label>
								<div class="col-sm-10">
									<input type="text" name='name' class="form-control" required="required" placeholder="此欄位對應到Google行事曆的活動名稱">
								</div>
							</div>

							<div class="form-group">
								<label class="col-sm-2 control-label">開始時間</label>
								<div class="col-sm-10">
									<div class='input-group datetimepicker'>
										<input type='text' name='start_time' class="form-control" required="required" onkeypress="return false"/>
										<span class="input-group-addon">
											<span class="glyphicon glyphicon-calendar"></span>
										</span>
									</div>
								</div>
							</div>

							<div class="form-group">
								<label class="col-sm-2 control-label">結束時間</label>
								<div class="col-sm-10">
									<div class='input-group datetimepicker'>
										<input type='text' name='end_time' class="form-control" required="required" onkeypress="return false"/>
										<span class="input-group-addon">
											<span class="glyphicon glyphicon-calendar"></span>
										</span>
									</div>
								</div>
							</div>
							
							<div class="form-group">
								<label class="col-sm-2 control-label">說明</label>
								<div class="col-sm-10">
									<textarea class="form-control" name='detail' rows="3"></textarea>
								</div>
							</div>
							
							<div class="form-group">
								<label class="col-sm-2 control-label">地點</label>
								<div class="col-sm-10">
									<input type="text" name='location' class="form-control" placeholder="">
								</div>
							</div>
							<button type="submit" class="btn btn-primary btn-lg btn-block">產生連結</button>
						</form>
					</div>
				</div>
			</div>

			<div class="row">
				<div class="col-sm-offset-1 col-sm-10">
					<dl class="dl-horizontal">
						<dt>URL</dt>
						<dd><a target='_blank' id='link'></a></dd>
					</dl>

					<dl class="dl-horizontal" id='shorter'>
						<dt>
							Google 短網址<br/>
							<button type="button" class="btn btn-info btn-sm">取得</button>
						</dt>
						<dd><a target='_blank'></a></dd>
					</dl>
				</div>
			</div>
		</div>
		
		<div class="container">
			<div class='row'>
				<div class="col-sm-offset-1 col-sm-10" id='footer'>
				
					<div class="list-group">
						<div class="list-group-item">
							<h4 class="list-group-item-heading">Notice</h4>
							<p class="list-group-item-text">
								<ul>
									<li>此網頁可單獨另存至本機執行，但需連接網路方可執行</li>
									<li>使用方法: 可打好產生連結後，透過Email或通訊軟體將該網址傳給與會人員，該員點選後即可加入至行事曆</li>
								</ul>
							</p>
						</div>
						<div class="list-group-item">
							<h4 class="list-group-item-heading">Using Package</h4>
							<p class="list-group-item-text">
								<ul>
									<li><a target='_blank' href='http://jquery.com/'>jQuery</a></li>
									<li><a target='_blank' href='https://eonasdan.github.io/bootstrap-datetimepicker/'>Bootstrap 3 Datepicker</a></li>
								</ul>
							</p>
						</div>
						<div class="list-group-item">
							<h4 class="list-group-item-heading">References</h4>
							<p class="list-group-item-text">
								<ul>
									<li><a target='_blank' href='http://steachs.com/archives/3805'>如何建立 Google 日曆連結</a>	</li>
									<li><a target='_blank' href='http://stackoverflow.com/questions/22757908/google-calendar-render-action-template-parameter-documentation'>Google Calendar Template parameter</a></li>
								</ul>
							</p>
						</div>
					</div>

				</div>
			</div>
		</div>

		<a href="https://github.com/Aspertw/GoogleCalenderEventGenerator"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/652c5b9acfaddf3a9c326fa6bde407b87f7be0f4/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.12.0/moment.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.12.0/locale/zh-tw.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/js/bootstrap-datetimepicker.min.js"></script>

		<script>
			var googleCalanderLinkMaker = function(param){
				var baseUrl = "https://www.google.com/calendar/render?action=TEMPLATE&trp=true&sf=true&output=xml";	
				var parseDateTime = function(datetime){
					var timestamp = Date.parse(datetime);
					if( isNaN(timestamp) ){ return false; }

					return new Date(timestamp).toISOString().replace(/[-:.]/g,'').substr(0,15)+'Z';
				};
				var makeUrl = function(param){
					if( !param ){ return false; }		
					var start_time = parseDateTime(param.start_time);
					var end_time = parseDateTime(param.end_time);
					
					if( !param.name || !start_time || !end_time){		
						return false;
					}

					var queryString = {
						text: param.name,
						dates: [start_time, end_time].join('/'),
						details: param.details,
						location: param.location,
					};
					return baseUrl + '&' + $.param(queryString);
				};
				return makeUrl(param);
			};

			var dateTimeTool = function(){
				var container = "form .datetimepicker";
				var startTimeElement = "input[name=start_time]";
				var endTimeElement = "input[name=end_time]";
				var datetimepickerOptions = {
					locale: 'zh-tw',		
					toolbarPlacement: 'bottom',
					dayViewHeaderFormat: 'YYYY MMMM',
					format: 'YYYY/MM/DD hh:mm',
					stepping: 30,
					sideBySide: true,
					allowInputToggle: true,
					showClose: true,
					showTodayButton: true,
				};
				
				var handleDateChange = function(){
					$(container + ' ' + startTimeElement).parent(container).on('dp.change', function(e){
						$(container + ' ' + endTimeElement).parent(container).data("DateTimePicker").minDate(e.date);
					});
				};

				var init = function(){
					$(container).datetimepicker(datetimepickerOptions);
					handleDateChange();
				}
				
				init();
			};

			var googleUrlShorten = function(url){
				if(!url || !url.length){ return false; }

				var apiUrl = 'https://www.googleapis.com/urlshortener/v1/url';
				var apiKey = 'AIzaSyCm8xp7Pc7YsAriKEqRADUQVML5Z07qsdk';

				var fetch = function(){
					return $.ajax({
						type: "POST",
						contentType: "application/json",
						url: (apiUrl + '?key=' + apiKey),
						dataType: "json",
						data: JSON.stringify({'longUrl': url}),
					});
				};

				fetch().done(function(data, textStatus, jqXHR){
					$("#shorter").trigger("success", [data.id]);
				}).fail(function(jqXHR, textStatus, errorThrown){
					$("#shorter").trigger("error", [errorThrown]);
				});
			};


			$(function(){
				dateTimeTool();

				$("form").submit(function(e){
					var param = {};
					$.each( $(this).serializeArray(), function(index, element){
						param[ element.name ] = element.value;
					});

					var url = googleCalanderLinkMaker(param);
					if( url ){
						$("#link").attr('href', url).text(url);
					}
					return false;
				});

				$("#shorter button").click(function(){
					// get generate url
					var url = $("#link").attr('href');
					if( !url ){ return false; }

					googleUrlShorten(url);

					$("#shorter")
						.on("success", function(e, shortUrl){
							$("#shorter a").text(shortUrl).attr('href', shortUrl);
						})
						.on("error", function(e){
							$("#shorter a").text('Request Shorten Url Error');
						});
				});
			});
		</script>
	</body>
</html>
